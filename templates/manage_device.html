<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Device</title>
    <link rel="stylesheet" href="../static/base.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body>
    {% include 'headers.html' %}
    {% include 'navbar.html' %}
    
    <div class="container mt-4">
        <span class="h3">Manage Devices</span>
        {% include 'flash.html' %}
        
        <div class="mt-4">
            <form id="manageDeviceForm">
                <input type="hidden" id="deviceId" name="deviceId">
                <div class="mb-3">
                    <label for="deviceName" class="form-label">Device Name</label>
                    <input type="text" class="form-control" id="deviceName" name="deviceName" required>
                </div>
                <div class="mb-3">
                    <label for="deviceType" class="form-label">Device Type</label>
                    <select id="deviceType" class="form-select" name="deviceType" required>
                        <option value="">Select Device Type</option>
                        <option value="sensor">Sensor</option>
                        <option value="actuator">Actuator</option>
                        <option value="controller">Controller</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="deviceStatus" class="form-label">Device Status</label>
                    <select id="deviceStatus" class="form-select" name="deviceStatus" required>
                        <option value="">Select Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
            </form>
        </div>

        <div class="mt-4">
            <h4>Existing Devices</h4>
            <table class="table table-striped" id="deviceTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Device data will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            loadDevices();

            $('#manageDeviceForm').on('submit', function (e) {
                e.preventDefault();
                const deviceId = $('#deviceId').val();
                const deviceName = $('#deviceName').val();
                const deviceType = $('#deviceType').val();
                const deviceStatus = $('#deviceStatus').val();

                const data = {
                    name: deviceName,
                    type: deviceType,
                    status: deviceStatus
                };

                const method = deviceId ? 'PUT' : 'POST';
                const url = deviceId ? `/api/devices/${deviceId}` : '/api/devices';

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        loadDevices();
                        resetForm();
                        alert(deviceId ? 'Device updated successfully' : 'Device added successfully');
                    },
                    error: function (xhr, status, error) {
                        let errorMessage = 'An unexpected error occurred.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.status === 404) {
                            errorMessage = 'Resource not found.';
                        } else if (xhr.status === 400) {
                            errorMessage = 'Bad request. Please check your input.';
                        } else if (xhr.status === 500) {
                            errorMessage = 'Internal server error. Please try again later.';
                        }
                        alert('Error: ' + errorMessage);
                    }
                });
            });

            $('#cancelEdit').on('click', function () {
                resetForm();
            });

            $(document).on('click', '.btn-edit', function () {
                const row = $(this).closest('tr');
                $('#deviceId').val(row.find('td:eq(0)').text());
                $('#deviceName').val(row.find('td:eq(1)').text());
                $('#deviceType').val(row.find('td:eq(2)').text().toLowerCase());
                $('#deviceStatus').val(row.find('td:eq(3)').text().toLowerCase());
            });

            $(document).on('click', '.btn-delete', function () {
                const deviceId = $(this).closest('tr').find('td:eq(0)').text();
                if (confirm('Are you sure you want to delete this device?')) {
                    $.ajax({
                        url: '/api/devices/' + deviceId,
                        method: 'DELETE',
                        success: function (response) {
                            loadDevices();
                            alert('Device deleted successfully');
                        },
                        error: function (xhr, status, error) {
                            let errorMessage = 'An unexpected error occurred.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            } else if (xhr.status === 404) {
                                errorMessage = 'Device not found.';
                            } else if (xhr.status === 500) {
                                errorMessage = 'Internal server error. Please try again later.';
                            }
                            alert('Error: ' + errorMessage);
                        }
                    });
                }
            });

            function loadDevices() {
                $.ajax({
                    url: '/api/devices',
                    method: 'GET',
                    success: function (devices) {
                        const tbody = $('#deviceTable tbody');
                        tbody.empty();
                        devices.forEach(function (device) {
                            tbody.append(`
                                <tr>
                                    <td>${device.id}</td>
                                    <td>${device.name}</td>
                                    <td>${device.type}</td>
                                    <td>${device.status}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm btn-edit">Edit</button>
                                        <button class="btn btn-danger btn-sm btn-delete">Delete</button>
                                    </td>
                                </tr>
                            `);
                        });
                    },
                    error: function (xhr, status, error) {
                        let errorMessage = 'An unexpected error occurred.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.status === 404) {
                            errorMessage = 'Devices not found.';
                        } else if (xhr.status === 500) {
                            errorMessage = 'Internal server error. Please try again later.';
                        }
                        alert('Error loading devices: ' + errorMessage);
                    }
                });
            }

            function resetForm() {
                $('#deviceId').val('');
                $('#deviceName').val('');
                $('#deviceType').val('');
                $('#deviceStatus').val('');
            }
        });
    </script>
</body>

</html>
