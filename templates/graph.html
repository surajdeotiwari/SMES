<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <title>{{title}}</title>
    <link rel="stylesheet" href="../static/base.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .chart-container {
            width: 100%;  /* Full width for responsiveness */
            height: auto;  /* Adjust the height as needed */
        }
        #myChart {
            width: 100%;
            height: 100%;
        }
        .button-container {
            text-align: center;  /* Center the buttons */
            margin-top: 10px;  /* Space above the buttons */
        }
        .info-section {
            margin: 20px 0;  /* Space around the information section */
        }
    </style>
</head>

<div class="container mt-5">
<body>
    {% include 'navbar.html' %}

        <div class="row">
            <!-- Left Column for Canvas -->
            <div class="col-md-8">
                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>
                <div class="button-container">
                    <button class="btn btn-primary" onclick="updateChart('lastHour')">Last Hour</button>
                    <button class="btn btn-primary" onclick="updateChart('last10Minutes')">Last 10 Minutes</button>
                    <button class="btn btn-primary" onclick="updateChart('lastMinute')">Last Minute</button>
                    <button class="btn btn-primary" onclick="updateChart('all')">All Data</button>
                </div>
            </div>

            <!-- Right Column for Guided Information -->
            <div class="col-md-4 info-section">
                <h4>Guided Information</h4>
                <p>Welcome to the data visualization dashboard. Here, you can view real-time data trends over various time intervals:</p>
                <ul>
                    <li><strong>Last Hour:</strong> View data for the last hour.</li>
                    <li><strong>Last 10 Minutes:</strong> View data for the last 10 minutes.</li>
                    <li><strong>Last Minute:</strong> View data for the last minute.</li>
                    <li><strong>All Data:</strong> View the entire data history.</li>
                </ul>
                <p>Use the buttons above to select the desired time range. The chart will update automatically every 10 seconds to show the most recent data.</p>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let myChart;

        document.addEventListener('DOMContentLoaded', function () {
            fetchDataAndCreateChart();

            // Fetch new data and update chart every 10 seconds
            setInterval(fetchData, 10000);
        });

        function fetchDataAndCreateChart() {
            fetch('/getData')
                .then(response => response.json())
                .then(data => {
                    allData = data.data;

                    const ctx = document.getElementById('myChart').getContext('2d');
                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Current',
                                data: [],
                                fill: false,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Voltage',
                                data: [],
                                fill: false,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Frequency',
                                data: [],
                                fill: false,
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Power',
                                data: [],
                                fill: false,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Energy',
                                data: [],
                                fill: false,
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute',
                                        tooltipFormat: 'HH:mm:ss',
                                        displayFormats: {
                                            minute: 'HH:mm',
                                            hour: 'HH:mm'
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    updateChart('last10Minutes');  // Default view
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function fetchData() {
            fetch('/getData')
                .then(response => response.json())
                .then(data => {
                    allData = data.data;
                    updateChart(document.querySelector('button.active').id);  // Update chart with the current view
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateChart(timeRange) {
            let now = moment();
            let filteredData = [];
            switch(timeRange) {
                case 'lastHour':
                    filteredData = allData.filter(item => moment(item.date).isBetween(now.clone().subtract(1, 'hour'), now));
                    break;
                case 'last10Minutes':
                    filteredData = allData.filter(item => moment(item.date).isBetween(now.clone().subtract(10, 'minutes'), now));
                    break;
                case 'lastMinute':
                    filteredData = allData.filter(item => moment(item.date).isBetween(now.clone().subtract(1, 'minute'), now));
                    break;
                case 'all':
                    filteredData = allData;
                    break;
            }

            // Extracting data for plotting
            const labels = filteredData.map(item => item.date);
            const currents = filteredData.map(item => item.current);
            const voltages = filteredData.map(item => item.voltage);
            const frequencies = filteredData.map(item => item.frequency);
            const powers = filteredData.map(item => item.power);
            const energies = filteredData.map(item => item.energy);

            // Update chart data
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = currents;
            myChart.data.datasets[1].data = voltages;
            myChart.data.datasets[2].data = frequencies;
            myChart.data.datasets[3].data = powers;
            myChart.data.datasets[4].data = energies;
            myChart.update();
        }
    </script>

    <!-- {% include 'footer.html' %} -->
</body>

</html>
